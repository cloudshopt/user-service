openapi: 3.0.3
info:
  title: CloudShopt User Service API
  version: 1.0.0
tags:
  - name: Health
  - name: Diagnostics
  - name: Auth

paths:
  /healthz:
    get:
      tags: [Health]
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusOkBool"

  /info:
    get:
      tags: [Diagnostics]
      summary: Service info (sha, time)
      responses:
        "200":
          description: Info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InfoResponse"

  /database:
    get:
      tags: [Diagnostics]
      summary: Database connectivity check
      responses:
        "200":
          description: DB OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DatabaseOkResponse"
        "500":
          description: DB connection failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DatabaseFailResponse"

  /auth/register:
    post:
      tags: [Auth]
      summary: Register user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: Registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "422":
          $ref: "#/components/responses/ValidationError"

  /auth/login:
    post:
      tags: [Auth]
      summary: Login user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Logged in
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "422":
          $ref: "#/components/responses/ValidationError"

  /me:
    get:
      tags: [Auth]
      summary: Get current user (JWT)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorMessage"
          examples:
            missingToken:
              value: { message: "Missing Bearer token" }
            invalid:
              value: { message: "Invalid or expired token" }

    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ValidationError"

  schemas:
    ErrorMessage:
      type: object
      required: [message]
      properties:
        message: { type: string }

    ValidationError:
      type: object
      required: [message, errors]
      properties:
        message: { type: string }
        errors:
          type: object
          additionalProperties:
            type: array
            items: { type: string }

    StatusOkBool:
      type: object
      required: [ok]
      properties:
        ok:
          type: boolean
          example: true

    InfoResponse:
      type: object
      required: [ok, service, sha, time]
      properties:
        ok: { type: boolean, example: true }
        service: { type: string, example: user-service }
        sha:
          type: string
          nullable: true
          example: 0.0.1
        time:
          type: string
          format: date-time
          example: "2026-01-29T10:15:30.123Z"

    DatabaseOkResponse:
      type: object
      required: [ok, db, time]
      properties:
        ok: { type: boolean, example: true }
        db:
          type: object
          required: [connection, database, ping_ms]
          properties:
            connection: { type: string, example: mysql }
            database: { type: string, example: cloudshopt_users_dev }
            ping_ms: { type: number, format: float, example: 1.25 }
        time:
          type: string
          format: date-time
          example: "2026-01-29T10:15:30.123Z"

    DatabaseFailResponse:
      type: object
      required: [ok, error, message]
      properties:
        ok: { type: boolean, example: false }
        error: { type: string, example: DB connection failed }
        message:
          type: string
          nullable: true
          example: "SQLSTATE[HY000] ..."

    User:
      type: object
      required: [id, name, email]
      properties:
        id: { type: integer, example: 2 }
        name: { type: string, example: Timotej }
        email: { type: string, format: email, example: timotej@test.com }

    RegisterRequest:
      type: object
      required: [name, email, password, password_confirmation]
      properties:
        name: { type: string }
        email: { type: string, format: email }
        password: { type: string, format: password }
        password_confirmation: { type: string, format: password }

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string, format: password }

    AuthResponse:
      type: object
      required: [token, token_type, expires_in, user]
      properties:
        token: { type: string }
        token_type: { type: string, example: Bearer }
        expires_in: { type: integer, example: 3600 }
        user:
          $ref: "#/components/schemas/User"

    MeResponse:
      type: object
      required: [user]
      properties:
        user:
          $ref: "#/components/schemas/User"